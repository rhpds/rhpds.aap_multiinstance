---
# SPDX-License-Identifier: MIT-0
# ===================================================================
# AAP Self-Service Custom Content - Main Tasks
# ===================================================================
# Configures AAP instances with demo content for self-service portal
#
# Supports both single-instance and multi-user deployments
# Uses agnosticd_user_data lookup to get AAP instance information

- name: Display role banner
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "AAP Self-Service Custom Content"
      - "========================================="
      - "Configuring AAP with demo users, inventories, credentials, and job templates"

# -------------------------------------------------------------------
# Get AAP Instance Information from Previous Workload
# -------------------------------------------------------------------
- name: Check if multi-user mode is enabled
  ansible.builtin.set_fact:
    _aap_multi_user_mode: "{{ lookup('agnosticd_user_data', 'aap_multi_user_mode') | default(false) | bool }}"

- name: Display deployment mode
  ansible.builtin.debug:
    msg: "Deployment mode: {{ 'Multi-user' if _aap_multi_user_mode else 'Single instance' }}"

# -------------------------------------------------------------------
# Single Instance Mode
# -------------------------------------------------------------------
- name: Configure single AAP instance
  when: not _aap_multi_user_mode
  block:
    - name: Get single instance AAP connection details
      ansible.builtin.set_fact:
        _aap_single_instance:
          controller_url: "{{ lookup('agnosticd_user_data', 'aap_controller_url') | default('') }}"
          admin_username: "{{ lookup('agnosticd_user_data', 'aap_admin_username') | default('admin') }}"
          admin_password: "{{ lookup('agnosticd_user_data', 'aap_admin_password') | default('') }}"

    - name: Validate single instance connection details
      ansible.builtin.assert:
        that:
          - _aap_single_instance.controller_url | length > 0
          - _aap_single_instance.admin_password | length > 0
        fail_msg: "AAP connection details not found. Ensure ocp4_workload_aap_multiinstance ran successfully."
        success_msg: "AAP connection details retrieved successfully"

    - name: Configure single AAP instance with demo content
      ansible.builtin.include_tasks: setup_instance_content.yml
      vars:
        aap_selfservice_custom_controller_url: "{{ _aap_single_instance.controller_url }}"
        aap_selfservice_custom_admin_username: "{{ _aap_single_instance.admin_username }}"
        aap_selfservice_custom_admin_password: "{{ _aap_single_instance.admin_password }}"
        instance_label: "single instance"

# -------------------------------------------------------------------
# Multi-User Mode
# -------------------------------------------------------------------
- name: Configure multiple AAP instances
  when: _aap_multi_user_mode
  block:
    - name: Get multi-user AAP instances list
      ansible.builtin.set_fact:
        _aap_instances: "{{ lookup('agnosticd_user_data', 'aap_instances') | default([]) }}"

    - name: Get common admin username
      ansible.builtin.set_fact:
        _aap_common_admin_username: "{{ lookup('agnosticd_user_data', 'aap_admin_username') | default('admin') }}"

    - name: Validate multi-user instance list
      ansible.builtin.assert:
        that:
          - _aap_instances | length > 0
        fail_msg: "No AAP instances found. Ensure ocp4_workload_aap_multiinstance ran in multi-user mode."
        success_msg: "Found {{ _aap_instances | length }} AAP instances to configure"

    - name: Display multi-user configuration plan
      ansible.builtin.debug:
        msg:
          - "Configuring {{ _aap_instances | length }} AAP instances with demo content"
          - "Users: {{ _aap_instances | map(attribute='user') | list | join(', ') }}"

    - name: Configure each AAP instance with demo content
      ansible.builtin.include_tasks: setup_instance_content.yml
      vars:
        aap_selfservice_custom_controller_url: "https://{{ aap_instance.route }}"
        aap_selfservice_custom_admin_username: "{{ _aap_common_admin_username }}"
        aap_selfservice_custom_admin_password: "{{ aap_instance.password }}"
        instance_label: "{{ aap_instance.user }}"
      loop: "{{ _aap_instances }}"
      loop_control:
        loop_var: aap_instance
        label: "{{ aap_instance.user }} - {{ aap_instance.route }}"

# -------------------------------------------------------------------
# Summary
# -------------------------------------------------------------------
- name: Display completion summary
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "AAP Custom Content Configuration Complete"
      - "========================================="
      - "Configured {{ _aap_instances | length if _aap_multi_user_mode else 1 }} AAP instance(s)"
      - ""
      - "Demo content added:"
      - "  - {{ aap_selfservice_custom_users | length }} users"
      - "  - {{ aap_selfservice_custom_inventories | length }} inventories"
      - "  - {{ aap_selfservice_custom_credentials | length }} credentials"
      - "  - {{ aap_selfservice_custom_projects | length }} projects"
      - "  - {{ aap_selfservice_custom_labels | length }} labels"
      - "  - {{ aap_selfservice_custom_job_templates | length }} job templates"
