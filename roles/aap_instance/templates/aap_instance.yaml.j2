---
apiVersion: aap.ansible.com/v1alpha1
kind: AnsibleAutomationPlatform
metadata:
  name: {{ instance_name }}
  namespace: {{ instance_namespace }}
  labels:
    app: ansible-automation-platform
    version: "{{ aap_instance_version }}"
spec:
  # Image settings
  image_pull_policy: {{ aap_instance_image_pull_policy }}

  # Redis configuration
  redis_mode: {{ aap_instance_redis_mode }}

  # Route configuration
  route_tls_termination_mechanism: {{ aap_instance_route_tls_termination }}

  # Disable logging sensitive data
  no_log: {{ aap_instance_no_log }}

  # ---------------------------------------------------------------
  # Automation Controller
  # ---------------------------------------------------------------
  controller:
    disabled: {{ not aap_instance_enable_controller }}
{% if aap_instance_enable_controller %}
    replicas: {{ aap_instance_controller_replicas }}

    # Web component
    web:
      replicas: {{ aap_instance_controller_web_replicas }}
      resource_requirements: {{ aap_instance_controller_web_resource_requirements | to_json }}

    # Task component
    task:
      replicas: {{ aap_instance_controller_task_replicas }}
      resource_requirements: {{ aap_instance_controller_task_resource_requirements | to_json }}

    # Admin credentials
    admin_user: {{ aap_instance_admin_username }}
    admin_password_secret: {{ instance_name }}-admin-password
{% endif %}

  # ---------------------------------------------------------------
  # Event-Driven Ansible (EDA)
  # ---------------------------------------------------------------
  eda:
    disabled: {{ not aap_instance_enable_eda }}
{% if aap_instance_enable_eda %}
    replicas: {{ aap_instance_eda_replicas }}
    resource_requirements: {{ aap_instance_eda_resource_requirements | to_json }}

    # Admin credentials
    admin_user: {{ aap_instance_admin_username }}
    admin_password_secret: {{ instance_name }}-admin-password
{% endif %}

  # ---------------------------------------------------------------
  # Private Automation Hub
  # ---------------------------------------------------------------
  hub:
    disabled: {{ not aap_instance_enable_hub }}
{% if aap_instance_enable_hub %}
    replicas: {{ aap_instance_hub_replicas }}

    # Gunicorn workers
    gunicorn_content_workers: {{ aap_instance_hub_content_workers }}
    gunicorn_api_workers: {{ aap_instance_hub_api_workers }}

    # Storage configuration
    file_storage_size: {{ aap_instance_hub_file_storage_size }}
    file_storage_access_mode: {{ aap_instance_hub_file_storage_access_mode }}
{% if aap_instance_hub_file_storage_class | default('') | length > 0 %}
    file_storage_storage_class: {{ aap_instance_hub_file_storage_class }}
{% endif %}

    # Worker and content replicas
    worker:
      replicas: {{ aap_instance_hub_content_workers }}
    content:
      replicas: {{ aap_instance_hub_content_workers }}

    # Resource requirements
    resource_requirements: {{ aap_instance_hub_resource_requirements | to_json }}

    # Admin credentials
    admin_password_secret: {{ instance_name }}-admin-password
{% endif %}

  # ---------------------------------------------------------------
  # Ansible Lightspeed
  # ---------------------------------------------------------------
  lightspeed:
    disabled: {{ not aap_instance_enable_lightspeed }}
