---
# - name: Fail if client_secret is still encrypted placeholder
#   fail:
#     msg: "client_secret is encrypted and has not been replaced! Remove or overwrite the var."
#   when: app_result.client_secret == "$encrypted$"

- name: "Create secret: secrets-rhaap-portal"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: secrets-rhaap-portal
        namespace: "{{ openshift_namespace }}"
      type: Opaque
      stringData:
        # AAP 2.6: Use Gateway URL (aap_controller_url), not controller-specific route
        aap-host-url: "{{ aap_controller_url }}"
        # AAP 2.6: Token from Gateway API
        aap-token: "{{ aap_token_result.json.token }}"
        # AAP 2.6: OAuth credentials from Gateway API
        oauth-client-id: "{{ app_result.json.client_id }}"
        oauth-client-secret: "{{ app_result.json.client_secret }}"

- name: Normalize tokens
  set_fact:
    _gitlab_token: "{{ gitlab_token | default('', true) }}"
    _github_token: "{{ github_token | default('', true) }}"

- name: Build secrets-scm data
  set_fact:
    scm_secret_data: >-
      {{
        dict(
          [('gitlab-token', _gitlab_token)] if _gitlab_token != '' else []
          +
          [('github-token', _github_token)] if _github_token != '' else []
        )
      }}


- name: "Create secret: secrets-scm"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: secrets-scm
        namespace: "{{ openshift_namespace }}"
      type: Opaque
      stringData: "{{ scm_secret_data }}"
