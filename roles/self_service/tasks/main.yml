#SPDX-License-Identifier: MIT-0
---
# Main entry point for self_service role
# Handles both single and multi-user deployments

# Deploy for single instance (when called with explicit variables from AgnosticV)
- name: Deploy self-service portal (single instance)
  when: aap_controller_url is defined
  include_tasks: deploy_portal.yml

# Deploy for each user in multi-user mode (read from cached facts)
- name: Deploy self-service portal for each user (multi-user mode)
  when:
    - aap_controller_url is not defined
    - aap_multiinstance_multi_user_mode | default(false) | bool
  include_tasks: deploy_portal.yml
  vars:
    controller_host: "https://{{ item.route }}"
    controller_username: "{{ aap_multiinstance_admin_username }}"
    controller_password: "{{ item.password }}"
    controller_verify_ssl: false
    aap_controller_url: "https://{{ item.route }}"
    aap_admin_username: "{{ aap_multiinstance_admin_username }}"
    aap_admin_password: "{{ item.password }}"
    aap_namespace: "{{ item.namespace }}"
    openshift_namespace: "{{ item.namespace }}-ssap"
  loop: "{{ aap_multiinstance_user_info | default([]) }}"
  loop_control:
    label: "{{ item.user }}"

# Deploy for single instance (read from cached facts)
- name: Deploy self-service portal (single instance from cached facts)
  when:
    - aap_controller_url is not defined
    - not aap_multiinstance_multi_user_mode | default(false) | bool
  include_tasks: deploy_portal.yml
  vars:
    controller_host: "{{ aap_multiinstance_deployment_info.controller_url }}"
    controller_username: "{{ aap_multiinstance_deployment_info.admin_username }}"
    controller_password: "{{ aap_multiinstance_deployment_info.admin_password }}"
    controller_verify_ssl: false
    aap_controller_url: "{{ aap_multiinstance_deployment_info.controller_url }}"
    aap_admin_username: "{{ aap_multiinstance_deployment_info.admin_username }}"
    aap_admin_password: "{{ aap_multiinstance_deployment_info.admin_password }}"
