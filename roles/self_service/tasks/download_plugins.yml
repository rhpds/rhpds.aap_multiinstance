---
# Download and extract self-service automation portal plugins from S3

- name: Parse S3 URL
  ansible.builtin.set_fact:
    _s3_bucket: "{{ service_automation_url | regex_replace('^s3://([^/]+)/.*', '\\1') }}"
    _s3_object: "{{ service_automation_url | regex_replace('^s3://[^/]+/(.*)', '\\1') }}"
  when: service_automation_url is defined and service_automation_url | length > 0

- name: Create temporary directory for plugin download
  ansible.builtin.tempfile:
    state: directory
    suffix: plugins
  register: _plugin_temp_dir

- name: Download self-service automation portal plugins tarball from S3
  amazon.aws.s3_object:
    bucket: "{{ _s3_bucket }}"
    object: "{{ _s3_object }}"
    dest: "{{ _plugin_temp_dir.path }}/plugins.tar.gz"
    mode: get
    aws_access_key: "{{ s3_aws_access_key | default(omit) }}"
    aws_secret_key: "{{ s3_aws_secret_key | default(omit) }}"
    region: "{{ s3_rhpds_private_region | default('us-east-1') }}"
  register: _plugin_download
  when: service_automation_url is defined and service_automation_url | length > 0

- name: Create plugins directory on bastion
  ansible.builtin.file:
    path: "{{ plugin_root_dir }}"
    state: directory
    mode: '0755'
  delegate_to: bastion

- name: Copy plugins tarball to bastion
  ansible.builtin.copy:
    src: "{{ _plugin_download.dest }}"
    dest: "{{ plugin_root_dir }}/plugins.tar.gz"
  delegate_to: bastion
  when: _plugin_download is defined and _plugin_download.dest is defined

- name: Extract plugins tarball on bastion
  ansible.builtin.unarchive:
    src: "{{ plugin_root_dir }}/plugins.tar.gz"
    dest: "{{ plugin_root_dir }}"
    remote_src: true
  delegate_to: bastion
  when: _plugin_download is defined and _plugin_download.dest is defined

- name: Remove tarball from bastion after extraction
  ansible.builtin.file:
    path: "{{ plugin_root_dir }}/plugins.tar.gz"
    state: absent
  delegate_to: bastion
  when: _plugin_download is defined and _plugin_download.dest is defined

- name: List extracted plugin files
  ansible.builtin.find:
    paths: "{{ plugin_root_dir }}"
    patterns: "*.tgz"
  delegate_to: bastion
  register: _plugin_files

- name: Show downloaded plugin files
  ansible.builtin.debug:
    msg: "Found {{ _plugin_files.matched }} plugin files in {{ plugin_root_dir }}"

- name: Clean up temporary directory
  ansible.builtin.file:
    path: "{{ _plugin_temp_dir.path }}"
    state: absent
  when: _plugin_temp_dir.path is defined
