- name: Create ImageStream for plugin-registry
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: image.openshift.io/v1
      kind: ImageStream
      metadata:
        name: plugin-registry
        namespace: "{{ openshift_namespace }}"

- name: Create BuildConfig for plugin-registry (binary build)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: build.openshift.io/v1
      kind: BuildConfig
      metadata:
        name: plugin-registry
        namespace: "{{ openshift_namespace }}"
        labels:
          app: plugin-registry
      spec:
        output:
          to:
            kind: ImageStreamTag
            name: plugin-registry:latest
        source:
          type: Binary
        strategy:
          type: Source
          sourceStrategy:
            from:
              kind: ImageStreamTag
              name: httpd:2.4-ubi8
              namespace: openshift
        triggers:
          - type: ConfigChange
  tags: [deploy_plugin]

- name: Check if oc command is available
  command: which oc
  register: oc_check
  failed_when: false
  changed_when: false
  delegate_to: localhost

- name: Start plugin-registry build from local dir
  command: >
    oc start-build plugin-registry
    --from-dir={{ plugin_root_dir }}
    --wait
    -n {{ openshift_namespace }}
  delegate_to: localhost
  when: oc_check.rc == 0
  environment:
    KUBECONFIG: "{{ lookup('env', 'K8S_AUTH_KUBECONFIG') | default(lookup('env', 'KUBECONFIG')) }}"

- name: Skip plugin build if oc not available
  debug:
    msg: "Skipping plugin build - oc command not available. Plugin registry will use empty image."
  when: oc_check.rc != 0
