- name: Create ImageStream for plugin-registry
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: image.openshift.io/v1
      kind: ImageStream
      metadata:
        name: plugin-registry
        namespace: "{{ openshift_namespace }}"

- name: Create BuildConfig for plugin-registry (binary build)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: build.openshift.io/v1
      kind: BuildConfig
      metadata:
        name: plugin-registry
        namespace: "{{ openshift_namespace }}"
        labels:
          app: plugin-registry
      spec:
        output:
          to:
            kind: ImageStreamTag
            name: plugin-registry:latest
        source:
          type: Binary
        strategy:
          type: Source
          sourceStrategy:
            from:
              kind: ImageStreamTag
              name: httpd:2.4-ubi8
              namespace: openshift
        triggers:
          - type: ConfigChange
  tags: [deploy_plugin]

- name: Start plugin-registry build from local dir (on bastion)
  delegate_to: bastion
  command: >
    oc start-build plugin-registry
    --from-dir={{ plugin_root_dir }}
    --wait
    -n {{ openshift_namespace }}
  register: plugin_build_result
  failed_when: false
  changed_when: plugin_build_result.rc == 0

- name: Show plugin build result
  debug:
    msg: "Plugin build {{ 'succeeded' if plugin_build_result.rc == 0 else 'failed (portal will work without custom plugins)' }}"
