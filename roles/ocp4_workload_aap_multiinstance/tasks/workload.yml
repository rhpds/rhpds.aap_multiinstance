---
# ---------------------------------------------------------------
# AAP Multi-Instance Workload Provisioning
# ---------------------------------------------------------------

- name: Print deployment configuration
  ansible.builtin.debug:
    msg:
      - "Deploying AAP Multi-Instance Workload"
      - "Version: {{ ocp4_workload_aap_multiinstance_version }}"
      - "Multi-user mode: {{ ocp4_workload_aap_multiinstance_multi_user }}"
      - "Number of users: {{ ocp4_workload_aap_multiinstance_num_users }}"
      - "Components: Controller={{ ocp4_workload_aap_multiinstance_enable_controller }}, EDA={{ ocp4_workload_aap_multiinstance_enable_eda }}, Hub={{ ocp4_workload_aap_multiinstance_enable_hub }}"

# ---------------------------------------------------------------
# AAP Deployment - directly integrated (no external role dependency)
# ---------------------------------------------------------------

# Map workload variables to aap_instance variables used by deployment tasks
- name: Set AAP deployment variables
  ansible.builtin.set_fact:
    aap_instance_name: "{{ ocp4_workload_aap_multiinstance_name }}"
    aap_instance_namespace: "{{ ocp4_workload_aap_multiinstance_namespace }}"
    aap_instance_version: "{{ ocp4_workload_aap_multiinstance_version }}"
    aap_instance_num_users: "{{ ocp4_workload_aap_multiinstance_num_users }}"
    aap_instance_multi_user: "{{ ocp4_workload_aap_multiinstance_multi_user }}"
    aap_instance_user_prefix: "{{ ocp4_workload_aap_multiinstance_user_prefix }}"
    aap_instance_user_password: "{{ ocp4_workload_aap_multiinstance_user_password }}"
    aap_instance_enable_controller: "{{ ocp4_workload_aap_multiinstance_enable_controller }}"
    aap_instance_enable_eda: "{{ ocp4_workload_aap_multiinstance_enable_eda }}"
    aap_instance_enable_hub: "{{ ocp4_workload_aap_multiinstance_enable_hub }}"
    aap_instance_enable_lightspeed: "{{ ocp4_workload_aap_multiinstance_enable_lightspeed }}"
    aap_instance_admin_password: "{{ ocp4_workload_aap_multiinstance_admin_password }}"
    aap_instance_admin_password_length: "{{ ocp4_workload_aap_multiinstance_admin_password_length }}"
    aap_instance_admin_username: "{{ ocp4_workload_aap_multiinstance_admin_username }}"
    aap_instance_password_salt: "{{ ocp4_workload_aap_multiinstance_password_salt }}"
    aap_instance_operator_channel: "{{ ocp4_workload_aap_multiinstance_operator_channel }}"
    aap_instance_operator_name: "{{ ocp4_workload_aap_multiinstance_operator_name }}"
    aap_instance_operator_csv_nameprefix: "{{ ocp4_workload_aap_multiinstance_operator_csv_nameprefix }}"
    aap_instance_operator_catalog: "{{ ocp4_workload_aap_multiinstance_operator_catalog }}"
    aap_instance_starting_csv: "{{ ocp4_workload_aap_multiinstance_starting_csv }}"
    aap_instance_automatic_install_plan_approval: "{{ ocp4_workload_aap_multiinstance_automatic_install_plan_approval }}"
    aap_instance_use_catalog_snapshot: "{{ ocp4_workload_aap_multiinstance_use_catalog_snapshot }}"
    aap_instance_catalogsource_name: "{{ ocp4_workload_aap_multiinstance_catalogsource_name }}"
    aap_instance_catalog_snapshot_image: "{{ ocp4_workload_aap_multiinstance_catalog_snapshot_image }}"
    aap_instance_catalog_snapshot_image_tag: "{{ ocp4_workload_aap_multiinstance_catalog_snapshot_image_tag }}"
    aap_instance_controller_replicas: "{{ ocp4_workload_aap_multiinstance_controller_replicas }}"
    aap_instance_controller_web_replicas: "{{ ocp4_workload_aap_multiinstance_controller_web_replicas }}"
    aap_instance_controller_task_replicas: "{{ ocp4_workload_aap_multiinstance_controller_task_replicas }}"
    aap_instance_controller_web_resource_requirements: "{{ ocp4_workload_aap_multiinstance_controller_web_resource_requirements }}"
    aap_instance_controller_task_resource_requirements: "{{ ocp4_workload_aap_multiinstance_controller_task_resource_requirements }}"
    aap_instance_eda_replicas: "{{ ocp4_workload_aap_multiinstance_eda_replicas }}"
    aap_instance_eda_resource_requirements: "{{ ocp4_workload_aap_multiinstance_eda_resource_requirements }}"
    aap_instance_eda_create_rolebinding: "{{ ocp4_workload_aap_multiinstance_eda_create_rolebinding }}"
    aap_instance_eda_service_account: "{{ ocp4_workload_aap_multiinstance_eda_service_account }}"
    aap_instance_eda_cluster_role: "{{ ocp4_workload_aap_multiinstance_eda_cluster_role }}"
    aap_instance_hub_replicas: "{{ ocp4_workload_aap_multiinstance_hub_replicas }}"
    aap_instance_hub_content_workers: "{{ ocp4_workload_aap_multiinstance_hub_content_workers }}"
    aap_instance_hub_api_workers: "{{ ocp4_workload_aap_multiinstance_hub_api_workers }}"
    aap_instance_hub_file_storage_size: "{{ ocp4_workload_aap_multiinstance_hub_file_storage_size }}"
    aap_instance_hub_file_storage_access_mode: "{{ ocp4_workload_aap_multiinstance_hub_file_storage_access_mode }}"
    aap_instance_hub_file_storage_class: "{{ ocp4_workload_aap_multiinstance_hub_file_storage_class }}"
    aap_instance_hub_resource_requirements: "{{ ocp4_workload_aap_multiinstance_hub_resource_requirements }}"
    aap_instance_inject_manifest: "{{ ocp4_workload_aap_multiinstance_inject_manifest }}"
    aap_instance_manifest: "{{ ocp4_workload_aap_multiinstance_manifest }}"
    aap_instance_ocp_token_lifecycle: "{{ ocp4_workload_aap_multiinstance_ocp_token_lifecycle }}"
    aap_instance_route_tls_termination: "{{ ocp4_workload_aap_multiinstance_route_tls_termination }}"
    aap_instance_redis_mode: "{{ ocp4_workload_aap_multiinstance_redis_mode }}"
    aap_instance_extra_wait_minutes: "{{ ocp4_workload_aap_multiinstance_extra_wait_minutes }}"
    aap_instance_no_log: "{{ ocp4_workload_aap_multiinstance_no_log }}"
    aap_instance_image_pull_policy: "{{ ocp4_workload_aap_multiinstance_image_pull_policy }}"

# Validate AAP configuration
- name: Validate AAP configuration
  ansible.builtin.include_tasks: validate.yml

# Setup AAP operator (single instance mode)
- name: Setup AAP operator and prerequisites (single instance)
  when: not aap_instance_multi_user | bool
  ansible.builtin.include_tasks: setup_operator.yml

# Deploy single AAP instance
- name: Deploy single AAP instance
  when: not aap_instance_multi_user | bool
  ansible.builtin.include_tasks: deploy_instance.yml
  vars:
    _instance_name: "{{ aap_instance_name }}"
    _instance_namespace: "{{ aap_instance_namespace }}"

# Deploy multiple AAP instances (multi-user mode)
- name: Deploy multiple AAP instances (multi-user mode)
  when: aap_instance_multi_user | bool
  ansible.builtin.include_tasks: deploy_multiuser.yml

# Store deployment info for user access tasks
- name: Store deployment information (internal use)
  ansible.builtin.set_fact:
    _aap_deployment_info: "{{ aap_instance_info | default({}) }}"
    _aap_multi_user_info: "{{ _user_access_info | default([]) }}"

# Store cacheable facts for self_service workload to consume
- name: Store cacheable facts for self_service workload
  ansible.builtin.set_fact:
    aap_multiinstance_deployment_info: "{{ aap_instance_info | default({}) }}"
    aap_multiinstance_user_info: "{{ _user_access_info | default([]) }}"
    aap_multiinstance_multi_user_mode: "{{ ocp4_workload_aap_multiinstance_multi_user | bool }}"
    aap_multiinstance_admin_username: "{{ ocp4_workload_aap_multiinstance_admin_username }}"
    cacheable: yes

- name: Grant user access to AAP namespaces (multi-user mode)
  when:
    - ocp4_workload_aap_multiinstance_multi_user | bool
    - ocp4_workload_aap_multiinstance_grant_user_access | bool
  ansible.builtin.include_tasks: grant_user_access.yml

# Wait for AAP Controller API to be ready before deploying portal
- name: Wait for AAP Controller API to be ready (multi-user)
  when: ocp4_workload_aap_multiinstance_multi_user | bool
  ansible.builtin.uri:
    url: "https://{{ item.route }}/api/v2/ping/"
    method: GET
    validate_certs: false
    status_code: 200
  register: _aap_api_check
  until: _aap_api_check.status == 200
  retries: 30
  delay: 10
  loop: "{{ _aap_multi_user_info }}"
  loop_control:
    label: "{{ item.user }}"

# Deploy self-service portal for each user (multi-user mode)
- name: Deploy self-service portal for each user
  ansible.builtin.include_role:
    name: rhpds.aap_self_service_portal.self_service
    tasks_from: deploy_portal
  vars:
    controller_host: "https://{{ item.route }}"
    controller_username: "{{ ocp4_workload_aap_multiinstance_admin_username }}"
    controller_password: "{{ item.password }}"
    controller_verify_ssl: false
    aap_controller_url: "https://{{ item.route }}"
    aap_admin_username: "{{ ocp4_workload_aap_multiinstance_admin_username }}"
    aap_admin_password: "{{ item.password }}"
    aap_namespace: "{{ item.namespace }}"
    openshift_namespace: "{{ item.namespace }}-ssap"
    aap_ssl_verify: false
    aap_oauth_client_name: "Self Service Portal"
    aap_organization: "Default"
    helm_chart_version: "2.0.3"
  loop: "{{ _aap_multi_user_info }}"
  loop_control:
    label: "{{ item.user }}"
  when: ocp4_workload_aap_multiinstance_multi_user | bool

# Wait for AAP Controller API to be ready (single instance)
- name: Wait for AAP Controller API to be ready (single instance)
  when: not ocp4_workload_aap_multiinstance_multi_user | bool
  ansible.builtin.uri:
    url: "{{ _aap_deployment_info.controller_url }}/api/v2/ping/"
    method: GET
    validate_certs: false
    status_code: 200
  register: _aap_api_check
  until: _aap_api_check.status == 200
  retries: 30
  delay: 10

# Deploy self-service portal (single instance mode)
- name: Deploy self-service portal (single instance)
  ansible.builtin.include_role:
    name: rhpds.aap_self_service_portal.self_service
    tasks_from: deploy_portal
  vars:
    controller_host: "{{ _aap_deployment_info.controller_url }}"
    controller_username: "{{ _aap_deployment_info.admin_username }}"
    controller_password: "{{ _aap_deployment_info.admin_password }}"
    controller_verify_ssl: false
    aap_controller_url: "{{ _aap_deployment_info.controller_url }}"
    aap_admin_username: "{{ _aap_deployment_info.admin_username }}"
    aap_admin_password: "{{ _aap_deployment_info.admin_password }}"
    aap_namespace: "{{ ocp4_workload_aap_multiinstance_namespace }}"
    openshift_namespace: "{{ ocp4_workload_aap_multiinstance_namespace }}-ssap"
    aap_ssl_verify: false
    aap_oauth_client_name: "Self Service Portal"
    aap_organization: "Default"
    helm_chart_version: "2.0.3"
  when: not ocp4_workload_aap_multiinstance_multi_user | bool

- name: Output user access information (single instance)
  when: not ocp4_workload_aap_multiinstance_multi_user | bool
  agnosticd.core.agnosticd_user_info:
    msg: |
      AAP Controller URL: {{ _aap_deployment_info.controller_url }}
      Admin Username: {{ _aap_deployment_info.admin_username }}
      Admin Password: {{ _aap_deployment_info.admin_password }}
    data:
      aap_controller_url: "{{ _aap_deployment_info.controller_url }}"
      aap_admin_username: "{{ _aap_deployment_info.admin_username }}"
      aap_admin_password: "{{ _aap_deployment_info.admin_password }}"

- name: Output user access information (multi-user mode)
  when: ocp4_workload_aap_multiinstance_multi_user | bool
  agnosticd.core.agnosticd_user_info:
    user: "{{ item.user }}"
    msg: |
      OpenShift Username: {{ item.user }}
      OpenShift Password: {{ ocp4_workload_aap_multiinstance_user_password }}
      AAP Controller: https://{{ item.route }}
      AAP Admin Username: {{ ocp4_workload_aap_multiinstance_admin_username }}
      AAP Admin Password: {{ item.password }}
      AAP Namespace: {{ item.namespace }}
    data:
      openshift_username: "{{ item.user }}"
      openshift_password: "{{ ocp4_workload_aap_multiinstance_user_password }}"
      aap_controller_url: "https://{{ item.route }}"
      aap_admin_username: "{{ ocp4_workload_aap_multiinstance_admin_username }}"
      aap_admin_password: "{{ item.password }}"
      aap_namespace: "{{ item.namespace }}"
  loop: "{{ _aap_multi_user_info }}"
  loop_control:
    label: "{{ item.user }}"
